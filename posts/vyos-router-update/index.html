<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Upgrading my 25gbit internet router to VyOS - Stefan Schüller</title><meta name=Description content><meta property="og:url" content="https://sschueller.github.io/posts/vyos-router-update/"><meta property="og:site_name" content="Stefan Schüller"><meta property="og:title" content="Upgrading my 25gbit internet router to VyOS"><meta property="og:description" content="It has been a while since I set up my original router for my 25gbit internet connection. I decided it was time to upgrade, but since I have some services running, I did not want to be down for too long and purchased some new hardware which would allow me to experiment with VyOS without affecting my current setup."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-16T16:37:16+02:00"><meta property="article:modified_time" content="2025-05-23T20:30:16+02:00"><meta property="article:tag" content="VyOS"><meta property="article:tag" content="Router"><meta property="article:tag" content="Firewall"><meta property="article:tag" content="FTTH"><meta property="article:tag" content="Network"><meta property="og:image" content="https://sschueller.github.io/posts/vyos-router-update/P_20250516_210518_1.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sschueller.github.io/posts/vyos-router-update/P_20250516_210518_1.jpg"><meta name=twitter:title content="Upgrading my 25gbit internet router to VyOS"><meta name=twitter:description content="It has been a while since I set up my original router for my 25gbit internet connection. I decided it was time to upgrade, but since I have some services running, I did not want to be down for too long and purchased some new hardware which would allow me to experiment with VyOS without affecting my current setup."><meta name=twitter:site content="@sschueller"><meta name=application-name content="Stefan Schüller"><meta name=apple-mobile-web-app-title content="Stefan Schüller"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://sschueller.github.io/posts/vyos-router-update/><link rel=prev href=https://sschueller.github.io/posts/turning-a-project-into-a-product/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Upgrading my 25gbit internet router to VyOS","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/sschueller.github.io\/posts\/vyos-router-update\/"},"genre":"posts","keywords":"VyOS, router, firewall, FTTH, Network","wordcount":2789,"url":"https:\/\/sschueller.github.io\/posts\/vyos-router-update\/","datePublished":"2025-05-16T16:37:16+02:00","dateModified":"2025-05-23T20:30:16+02:00","publisher":{"@type":"Organization","name":"Stefan Schüller"},"author":{"@type":"Person","name":"Stefan Schüller"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="https://stats2.tei.li/",_paq.push(["setTrackerUrl",e+"mtr"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"mts",s.parentNode.insertBefore(t,s)}()</script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"light"==="light"||"light"==="dark"||"light"==="black"?(setTheme("light"),saveTheme("light")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Stefan Schüller">Stefan Schüller</a></div><div class=menu><div class=menu-inner><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Stefan Schüller">Stefan Schüller</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#the-plan>The Plan</a></li><li><a href=#interface-configuration>Interface configuration</a><ul><li><a href=#physical-interfaces>Physical interfaces</a></li><li><a href=#vlans-and-bridges>VLANs and bridges</a></li></ul></li><li><a href=#hardware-issues>Hardware Issues</a><ul><li><a href=#mellanox-connectx-4-lx-compatibility>Mellanox ConnectX-4 LX compatibility</a></li><li><a href=#heat>Heat</a></li></ul></li><li><a href=#vyos-setup>VyOS Setup</a><ul><li><a href=#initial-setup>Initial Setup</a></li><li><a href=#interfaces>Interfaces</a></li><li><a href=#vlans--bridges>VLANs / Bridges</a></li><li><a href=#backup>Backup</a></li><li><a href=#ddns>DDNS</a></li><li><a href=#dmz-hosted-sites>DMZ (Hosted sites)</a></li><li><a href=#wan-failover>WAN failover</a></li><li><a href=#routing--firewall>Routing / Firewall</a></li></ul></li><li><a href=#wireguard>Wireguard</a><ul><li></li><li><a href=#todo>TODO:</a></li></ul></li><li><a href=#performance>Performance</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Upgrading my 25gbit internet router to VyOS</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://github.com/sschueller/ title=Author target=_blank rel="noopener noreferrer author" class=author>Stefan Schüller</a>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>category <a href=/categories/projects/><i class="far fa-folder fa-fw"></i>Projects</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2025-05-16>2025-05-16</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2025-05-23>2025-05-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2789 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;14 minutes&nbsp;</div></div><div class=featured-image><img loading=eager src=/posts/vyos-router-update/P_20250516_210518_1.jpg srcset="/posts/vyos-router-update/P_20250516_210518_1.jpg, /posts/vyos-router-update/P_20250516_210518_1.jpg 1.5x, /posts/vyos-router-update/P_20250516_210518_1.jpg 2x" sizes=auto alt=/posts/vyos-router-update/P_20250516_210518_1.jpg title=/posts/vyos-router-update/P_20250516_210518_1.jpg height=2610 width=3441></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#the-plan>The Plan</a></li><li><a href=#interface-configuration>Interface configuration</a><ul><li><a href=#physical-interfaces>Physical interfaces</a></li><li><a href=#vlans-and-bridges>VLANs and bridges</a></li></ul></li><li><a href=#hardware-issues>Hardware Issues</a><ul><li><a href=#mellanox-connectx-4-lx-compatibility>Mellanox ConnectX-4 LX compatibility</a></li><li><a href=#heat>Heat</a></li></ul></li><li><a href=#vyos-setup>VyOS Setup</a><ul><li><a href=#initial-setup>Initial Setup</a></li><li><a href=#interfaces>Interfaces</a></li><li><a href=#vlans--bridges>VLANs / Bridges</a></li><li><a href=#backup>Backup</a></li><li><a href=#ddns>DDNS</a></li><li><a href=#dmz-hosted-sites>DMZ (Hosted sites)</a></li><li><a href=#wan-failover>WAN failover</a></li><li><a href=#routing--firewall>Routing / Firewall</a></li></ul></li><li><a href=#wireguard>Wireguard</a><ul><li></li><li><a href=#todo>TODO:</a></li></ul></li><li><a href=#performance>Performance</a></li></ul></nav></div></div><div class=content id=content><p>It has been a while since I set up my <a href=/posts/wiring-a-home-with-fiber rel>original router for my 25gbit internet connection</a>. I decided it was time to upgrade, but since I have some services running, I did not want to be down for too long and purchased some new hardware which would allow me to experiment with <a href=https://vyos.io/ target=_blank rel="noopener noreferrer">VyOS</a> without affecting my current setup.</p><p>There has been a lot of talk around the <a href=https://minisforumpc.eu/en/products/ms-01 target=_blank rel="noopener noreferrer">MS-01</a> since it came out about a year ago, so I decided to purchase one. Additionally, I purchased a cheap (CHF 42.-) used <a href=https://www.nvidia.com/en-in/networking/ethernet/connectx-4-lx/ target=_blank rel="noopener noreferrer">Mellanox SFP28</a> card from AliExpress.</p><p>The following post contains specific types of configurations I needed and how I set them up.</p><h2 id=the-plan class=headerLink><a href=#the-plan class=header-mark></a>The Plan</h2><p>My plan was to install Proxmox on the MS-01, just like on the &ldquo;old&rdquo; server/router, and run VyOS as a VM. The primary reason for this is to make upgrading and backup easier.</p><h2 id=interface-configuration class=headerLink><a href=#interface-configuration class=header-mark></a>Interface configuration</h2><h3 id=physical-interfaces class=headerLink><a href=#physical-interfaces class=header-mark></a>Physical interfaces</h3><p><figure><a class=lightgallery href=/posts/vyos-router-update/interfaces.png title="MS-01 Interfaces" data-thumbnail=/posts/vyos-router-update/interfaces.png><img loading=lazy src=/posts/vyos-router-update/interfaces.png srcset="/posts/vyos-router-update/interfaces.png, /posts/vyos-router-update/interfaces.png 1.5x, /posts/vyos-router-update/interfaces.png 2x" sizes=auto alt="MS-01 Interfaces" height=397 width=711></a></figure></p><p>I use PCI passthrough to the VyOS VM for the onboard SFP+ and the Mellanox SFP28 PCIe card. One onboard 2.5G is bridged in via Proxmox as well as a bridge with no physical NICs to connect VMs running on MS-01 with VyOS.</p><h3 id=vlans-and-bridges class=headerLink><a href=#vlans-and-bridges class=header-mark></a>VLANs and bridges</h3><p><figure><a class=lightgallery href=/posts/vyos-router-update/vlans.png title="VyOS VLANs" data-thumbnail=/posts/vyos-router-update/vlans.png><img loading=lazy src=/posts/vyos-router-update/vlans.png srcset="/posts/vyos-router-update/vlans.png, /posts/vyos-router-update/vlans.png 1.5x, /posts/vyos-router-update/vlans.png 2x" sizes=auto alt="VyOS VLANs" height=641 width=1340></a></figure></p><p>The only reason I am even using VLANs is because one of the WANs is located at another part of the house and I did not want to use more than one fiber (which would require more SFP+ modules etc.) to get that WAN to the router.</p><p>I have several VLANs at this time which are:</p><ul><li>100 LAN</li><li>150 Swisscom WAN</li><li>200 DMZ (This one did not exist in the old setup, I used it to connect a trunk between the two instances of Proxmox I now have)</li><li>900 Management</li></ul><p>I decided to use bridges in VyOS to connect VLANs and physical interfaces together as well as apply firewall/routing rules</p><h2 id=hardware-issues class=headerLink><a href=#hardware-issues class=header-mark></a>Hardware Issues</h2><h3 id=mellanox-connectx-4-lx-compatibility class=headerLink><a href=#mellanox-connectx-4-lx-compatibility class=header-mark></a>Mellanox ConnectX-4 LX compatibility</h3><p>Unlike the Broadcom card in the other server, the Mellanox initially did not work with the SFP28 module from FlexOptix which the ISP (Init7) provided. One option would have been to re-program the SFP28 using a programmer which we have at work, but I did not want to have to re-program the SFP28 every time I wanted to switch which PC it was in.</p><p>The solution was to switch to another firmware version of the Mellanox card which did not care about the SFP28 vendor ID.</p><blockquote><p>Thank you to the <a href=https://old.reddit.com/r/init7/ target=_blank rel="noopener noreferrer">Init7 community on reddit</a> for this tip.:)</p></blockquote><p>I downgraded to version: <code>fw-ConnectX4Lx-rel-14_24_1000-MCX4121A-ACA_Ax-UEFI-14.17.11-FlexBoot-3.5.603.bin</code></p><p>Flashing process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># get the tool</span>
</span></span><span style=display:flex><span>apt install proxmox-default-headers linux-headers linux-headers-generic linux-headers-amd64
</span></span><span style=display:flex><span>wget https://www.mellanox.com/downloads/MFT/mft-4.31.0-149-x86_64-deb.tgz
</span></span><span style=display:flex><span>tar -vxzf mft-4.31.0-149-x86_64-deb.tgz 
</span></span><span style=display:flex><span>cd mft-4.31.0-149-x86_64-deb/
</span></span><span style=display:flex><span>./install.sh 
</span></span><span style=display:flex><span>mst start
</span></span><span style=display:flex><span><span style=color:#75715e># find card id</span>
</span></span><span style=display:flex><span>lspci | grep Mellanox
</span></span><span style=display:flex><span><span style=color:#75715e># list current version</span>
</span></span><span style=display:flex><span>flint -d 01:00.0 q full
</span></span><span style=display:flex><span><span style=color:#75715e># download version</span>
</span></span><span style=display:flex><span>wget https://www.mellanox.com/downloads/firmware/fw-ConnectX4Lx-rel-14_24_1000-MCX4121A-ACA_Ax-UEFI-14.17.11-FlexBoot-3.5.603.bin.zip
</span></span><span style=display:flex><span>unzip fw-ConnectX4Lx-rel-14_24_1000-MCX4121A-ACA_Ax-UEFI-14.17.11-FlexBoot-3.5.603.bin.zip
</span></span><span style=display:flex><span><span style=color:#75715e># flash other version</span>
</span></span><span style=display:flex><span>flint -d 01:00.0 -i fw-ConnectX4Lx-rel-14_24_1000-MCX4121A-ACA_Ax-UEFI-14.17.11-FlexBoot-3.5.603.bin b
</span></span></code></pre></div><h3 id=heat class=headerLink><a href=#heat class=header-mark></a>Heat</h3><p>After using the MS-01 for a while I noticed that the heat of the PCIe card is not dealt with correctly. I added Nactua 5V fan which includes a USB adapter to the outside of the case to deal with this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># check temp</span>
</span></span><span style=display:flex><span>mget_temp -d 01:00.0
</span></span></code></pre></div><p><figure><a class=lightgallery href=/posts/vyos-router-update/P_20250523_154448.jpg title="MS-01 Nactua USB Fan" data-thumbnail=/posts/vyos-router-update/P_20250523_154448.jpg><img loading=lazy src=/posts/vyos-router-update/P_20250523_154448.jpg srcset="/posts/vyos-router-update/P_20250523_154448.jpg, /posts/vyos-router-update/P_20250523_154448.jpg 1.5x, /posts/vyos-router-update/P_20250523_154448.jpg 2x" sizes=auto alt="MS-01 Nactua USB Fan" height=3432 width=4576></a></figure></p><p>I went from <code>108°C</code> to <code>45°C</code>&mldr;</p><h2 id=vyos-setup class=headerLink><a href=#vyos-setup class=header-mark></a>VyOS Setup</h2><blockquote><p>Many thanks to <a href=https://www.problemofnetwork.com/posts/updating-my-fiber7-vyos-config-to-1dot5/ target=_blank rel="noopener noreferrer">John Howard</a> for the example VyOS setup he posted, which got me going in the right direction.</p></blockquote><p>I am new to VyOS so here are a few things that I &ldquo;learned&rdquo; setting up my VM.</p><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>VyOS Configuration<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>If you get stuck and your configuration looks good yet it doesn&rsquo;t work, I highly suggest you reset your VyOS. I have had a situation where my configuration committed fine but didn&rsquo;t work as expected. Only once I reset and tried to load the full configuration was I given an error which led me to fix my issue.</p><p>I also recommend using the quarterly LTS version and not the rolling release which may have issues.</p></div></div></div><h3 id=initial-setup class=headerLink><a href=#initial-setup class=header-mark></a>Initial Setup</h3><p>I configured VyOS with 4 sockets and 4 cores as well as 4GB of RAM (probably overkill at this time). After booting the live environment of the ISO, I ran the setup process to install VyOS to disk.</p><p>In order to make my life easier and not having to type my entire config into the KVM shell, I added a <code>virtiofs</code> file system. This allows me to edit the file via an SSH session to the Proxmox server and then load it into VyOS until I have SSH access directly into the VyOS VM.</p><p>I only need to enter <code>sudo mount -t virtiofs vyos-config /mnt</code> in VyOS via the shell and then run <code>load /mnt/myconfig</code> in the <code>configure</code> mode.</p><p>I also added it to the fstab so it is mounted on reboot:</p><pre tabindex=0><code>vyos-config /mnt virtiofs rw,relatime 0 0
</code></pre><h3 id=interfaces class=headerLink><a href=#interfaces class=header-mark></a>Interfaces</h3><p>I remapped my interfaces to match the order I wanted, and if for any reason VyOS detects them in a different order after an update, I am not affected.</p><p>In order for this to work, I had to copy out the auto-generated <code>/config/config.boot</code>, edit the MAC addresses and names, and then copy it back. After a restart, the interfaces were then correctly assigned as I wanted them.</p><pre tabindex=0><code>interfaces {
    ethernet eth0 {
        hw-id 58:47:ca:xx:xx:xx
        offload {
            gro
            gso
            sg
            tso
        }
    }
    ...
}
...
</code></pre><h3 id=vlans--bridges class=headerLink><a href=#vlans--bridges class=header-mark></a>VLANs / Bridges</h3><p>I set up several bridges (non-VLAN aware) which connected the VLANs together.</p><p>For example, the br200, which is my DMZ, connected the trunk port going to my &ldquo;old server&rdquo; as well as the trunk going to Proxmox itself on which VyOS is running so I can connect services running on there as well.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>interfaces <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    bridge br200 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        address <span style=color:#e6db74>&#34;10.20.10.1/24&#34;</span>
</span></span><span style=display:flex><span>        description <span style=color:#e6db74>&#34;Bridge for VLAN 200 (DMZ1)&#34;</span>
</span></span><span style=display:flex><span>        ip
</span></span><span style=display:flex><span>        member <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            interface eth4.200 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            interface eth6.200 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    ethernet eth4 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        description <span style=color:#e6db74>&#34;Trunk Port (VLAN 100 &amp; 150)&#34;</span>
</span></span><span style=display:flex><span>        hw-id <span style=color:#e6db74>&#34;50:6b:4b:xx:xx:xx&#34;</span>
</span></span><span style=display:flex><span>        offload <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            gro
</span></span><span style=display:flex><span>            gso
</span></span><span style=display:flex><span>            sg
</span></span><span style=display:flex><span>            tso
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        vif <span style=color:#ae81ff>100</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            description <span style=color:#e6db74>&#34;LAN (VLAN 100)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        vif <span style=color:#ae81ff>150</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            description <span style=color:#e6db74>&#34;Swisscom WAN (VLAN 150)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        vif <span style=color:#ae81ff>200</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            description <span style=color:#e6db74>&#34;DMZ1 (VLAN 200)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        vif <span style=color:#ae81ff>900</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            description <span style=color:#e6db74>&#34;MGMT (MGMT 900)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    ethernet eth6 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        description <span style=color:#e6db74>&#34;Proxmox Trunk&#34;</span>
</span></span><span style=display:flex><span>        hw-id <span style=color:#e6db74>&#34;bc:24:11:xx:xx:xx&#34;</span>
</span></span><span style=display:flex><span>        offload <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            gro
</span></span><span style=display:flex><span>            gso
</span></span><span style=display:flex><span>            sg
</span></span><span style=display:flex><span>            tso
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        vif <span style=color:#ae81ff>100</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            description <span style=color:#e6db74>&#34;LAN (VLAN 100)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>        
</span></span><span style=display:flex><span>        vif <span style=color:#ae81ff>200</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            description <span style=color:#e6db74>&#34;DMZ1 (VLAN 200)&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=vlans-routing-issue class=headerLink><a href=#vlans-routing-issue class=header-mark></a>VLANs Routing Issue</h4><p>Initaliy I ran into an issue where I could not route traffic between for example <code>eth4.200</code> and <code>eth6.200</code> but traffic did go from either one of those to vyos. After several days arguing with ChatGPT to Deepseek I found my mistake (without any AI being even close) which was my load-balancing rule, it was missing the exclusion for br200&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>12</span> destination address <span style=color:#e6db74>&#39;10.20.10.0/24&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>12</span> exclude
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>12</span> inbound-interface <span style=color:#e6db74>&#39;br200&#39;</span>
</span></span></code></pre></div><p><figure><a class=lightgallery href=/posts/vyos-router-update/IMG_20250426_232730_329.jpg title="Me after arguing with AIs for days" data-thumbnail=/posts/vyos-router-update/IMG_20250426_232730_329.jpg><img loading=lazy src=/posts/vyos-router-update/IMG_20250426_232730_329.jpg srcset="/posts/vyos-router-update/IMG_20250426_232730_329.jpg, /posts/vyos-router-update/IMG_20250426_232730_329.jpg 1.5x, /posts/vyos-router-update/IMG_20250426_232730_329.jpg 2x" sizes=auto alt="Me after arguing with AIs for days" height=853 width=1280></a></figure></p><h3 id=backup class=headerLink><a href=#backup class=header-mark></a>Backup</h3><p>For backup at this time, I have two cronjobs in the VyOS VM to export the structure config and the commands config. These also go into the <code>virtiofs</code> mount.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> * * * /opt/vyatta/bin/vyatta-op-cmd-wrapper show configuration commands &gt; /mnt/backups/config.commands.<span style=color:#66d9ef>$(</span>date --iso-8601<span style=color:#f92672>=</span>seconds<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> * * * cp /config/config.boot /mnt/backups/vyos-config.<span style=color:#66d9ef>$(</span>date --iso-8601<span style=color:#f92672>=</span>seconds<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>The second export can be loaded into VyOS via <code>load</code> command</p><h3 id=ddns class=headerLink><a href=#ddns class=header-mark></a>DDNS</h3><p>I do not have a fixed IP (although it doesn&rsquo;t really change very often) so I also send updates to an external DDNS/DNS server of mine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set service dns dynamic name dedyn description <span style=color:#e6db74>&#39;Dynamic dns service&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic name dedyn username <span style=color:#e6db74>&#39;myusername&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic name dedyn password <span style=color:#e6db74>&#39;mypassword&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic name dedyn host-name <span style=color:#e6db74>&#39;myhostname&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic name dedyn protocol <span style=color:#e6db74>&#39;dyndns2&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic name dedyn server <span style=color:#e6db74>&#39;my ddns server&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic name dedyn address interface <span style=color:#e6db74>&#39;eth2&#39;</span>
</span></span><span style=display:flex><span>set service dns dynamic interval <span style=color:#ae81ff>300</span>
</span></span></code></pre></div><h3 id=dmz-hosted-sites class=headerLink><a href=#dmz-hosted-sites class=header-mark></a>DMZ (Hosted sites)</h3><p>For the services I am hosting directly from my connection, like Matrix server and Mastodon, I have a DMZ setup. All the services are behind an nginx reverse proxy which also deals with SSL certificates.</p><p>I have a NAT rule going to the proxy as well as the appropriate firewall settings</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>10443</span> description <span style=color:#e6db74>&#39;HTTPS to Ingress&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>10443</span> destination port <span style=color:#e6db74>&#39;443&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>10443</span> inbound-interface name <span style=color:#e6db74>&#39;eth2&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>10443</span> protocol <span style=color:#e6db74>&#39;tcp_udp&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>10443</span> translation address <span style=color:#e6db74>&#39;10.20.10.200&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>10443</span> translation port <span style=color:#e6db74>&#39;443&#39;</span>
</span></span></code></pre></div><p>Preserve IPs for nginx proxy x-forwarded-for header</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set load-balancing wan disable-source-nat
</span></span></code></pre></div><h4 id=special-routing class=headerLink><a href=#special-routing class=header-mark></a>Special routing</h4><p>For these sites to work from within my LAN there are two options.</p><p>The first one would be to use Hairpin NAT but unlike <a href=https://docs.opnsense.org/manual/how-tos/nat_reflection.html target=_blank rel="noopener noreferrer">opnsense</a> it does not work as well especially if the port is 443 or 80 as in my case.</p><p>For this reason I decided to use Split DNS which is just defining the interal IP of a service on my local DNS server which I use on all my clients.</p><p>So for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set system static-host-mapping host-name mywebsite.com inet <span style=color:#e6db74>&#39;10.20.10.99&#39;</span>
</span></span></code></pre></div><p>This caused an issue with my GitLab server when using SSH as it would send traffic to my proxy and not my actual GitLab server.</p><p>To solve this, I set up a &ldquo;SSH Proxy&rdquo; on my nginx proxy like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>stream <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  upstream ssh <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># the gitlab server</span>
</span></span><span style=display:flex><span>        server 10.20.10.101:1234;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># where ssh listens</span>
</span></span><span style=display:flex><span>        listen 1234;
</span></span><span style=display:flex><span>        proxy_pass ssh;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=wan-failover class=headerLink><a href=#wan-failover class=header-mark></a>WAN failover</h3><p>I have 3 WANs which I have specific order in which they should be used. The following will use the Init7 primarily and failover to the slower connections in order.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set load-balancing wan enable-local-traffic
</span></span><span style=display:flex><span>set load-balancing wan flush-connections
</span></span><span style=display:flex><span>set load-balancing wan sticky-connections inbound
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># init 7</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health eth2 nexthop <span style=color:#e6db74>&#39;dhcp&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health eth2 test <span style=color:#ae81ff>1</span> target <span style=color:#e6db74>&#39;8.8.8.8&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health eth2 test <span style=color:#ae81ff>1</span> type <span style=color:#e6db74>&#39;ping&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Swisscom</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health br150 nexthop <span style=color:#e6db74>&#39;dhcp&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health br150 test <span style=color:#ae81ff>1</span> target <span style=color:#e6db74>&#39;8.8.8.8&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health br150 test <span style=color:#ae81ff>1</span> type <span style=color:#e6db74>&#39;ping&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Yallo</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health eth5 nexthop <span style=color:#e6db74>&#39;dhcp&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health eth5 test <span style=color:#ae81ff>1</span> target <span style=color:#e6db74>&#39;192.168.8.1&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan interface-health eth5 test <span style=color:#ae81ff>1</span> type <span style=color:#e6db74>&#39;ping&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># rule for LAN</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>20</span> failover
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>20</span> inbound-interface <span style=color:#e6db74>&#39;br100&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>20</span> interface br150 weight <span style=color:#e6db74>&#39;100&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>20</span> interface eth2 weight <span style=color:#e6db74>&#39;150&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>20</span> interface eth5 weight <span style=color:#e6db74>&#39;50&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>20</span> protocol <span style=color:#e6db74>&#39;all&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># rule for DMZ</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>30</span> failover
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>30</span> inbound-interface <span style=color:#e6db74>&#39;br200&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>30</span> interface br150 weight <span style=color:#e6db74>&#39;100&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>30</span> interface eth2 weight <span style=color:#e6db74>&#39;150&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>30</span> interface eth5 weight <span style=color:#e6db74>&#39;50&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>30</span> protocol <span style=color:#e6db74>&#39;all&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># to prevent local traffic from going through the load-balancer the following are needed</span>
</span></span><span style=display:flex><span><span style=color:#75715e># if these are missing inter brige routing will not work</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>10</span> destination address <span style=color:#e6db74>&#39;10.10.10.0/24&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>10</span> exclude
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>10</span> inbound-interface <span style=color:#e6db74>&#39;br100&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>11</span> destination address <span style=color:#e6db74>&#39;10.20.10.0/24&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>11</span> exclude
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>11</span> inbound-interface <span style=color:#e6db74>&#39;br100&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>12</span> destination address <span style=color:#e6db74>&#39;10.20.10.0/24&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>12</span> exclude
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>12</span> inbound-interface <span style=color:#e6db74>&#39;br200&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>13</span> destination address <span style=color:#e6db74>&#39;10.99.10.0/24&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>13</span> exclude
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>13</span> inbound-interface <span style=color:#e6db74>&#39;br900&#39;</span>
</span></span></code></pre></div><p>For traffic from vyos like ddns calls and wireguard the next-hop distance needs to be adjusted or you will have traffic going out random routes. Since all my WANs are DHCP I can not set static routes so I set the route distance in the DHCP client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set interfaces ethernet eth2 dhcp-options default-route-distance <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>set interfaces bridge br150 dhcp-options default-route-distance <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>set interfaces ethernet eth6 dhcp-options default-route-distance <span style=color:#ae81ff>30</span>
</span></span></code></pre></div><p>This will result in routes like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vyos@ch3# run show ip route
</span></span><span style=display:flex><span>Codes: K - kernel route, C - connected, S - static, R - RIP,
</span></span><span style=display:flex><span>       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
</span></span><span style=display:flex><span>       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
</span></span><span style=display:flex><span>       f - OpenFabric,
</span></span><span style=display:flex><span>       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
</span></span><span style=display:flex><span>       t - trapped, o - offload failure
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>S&gt;* 0.0.0.0/0 <span style=color:#f92672>[</span>10/0<span style=color:#f92672>]</span> via 212.xxx.xxx.1, eth2, weight 1, 00:00:09
</span></span><span style=display:flex><span>S   0.0.0.0/0 <span style=color:#f92672>[</span>30/0<span style=color:#f92672>]</span> via 192.168.8.1, eth5, weight 1, 00:00:11
</span></span><span style=display:flex><span>S   0.0.0.0/0 <span style=color:#f92672>[</span>20/0<span style=color:#f92672>]</span> via 192.168.10.1, br150, weight 1, 00:00:13
</span></span></code></pre></div><h3 id=routing--firewall class=headerLink><a href=#routing--firewall class=header-mark></a>Routing / Firewall</h3><p>As I mentioned above, I used <a href=https://www.problemofnetwork.com/posts/updating-my-fiber7-vyos-config-to-1dot5/ target=_blank rel="noopener noreferrer">John&rsquo;s blog</a> as a starting point and added a DMZ zone for my hosted services. I also applied my firewall rules to bridges instead of directly the interfaces. Thank you John for the great write up.</p><h2 id=wireguard class=headerLink><a href=#wireguard class=header-mark></a>Wireguard</h2><p>Standard road-warrior setup for laptops and phones as well as some remote fixed locations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set interfaces wireguard wg1 address <span style=color:#e6db74>&#39;10.25.30.1/24&#39;</span>
</span></span><span style=display:flex><span>set interfaces wireguard wg1 description <span style=color:#e6db74>&#39;HomeWireGuard&#39;</span>
</span></span><span style=display:flex><span>set interfaces wireguard wg1 peer mobile_client allowed-ips <span style=color:#e6db74>&#39;10.25.30.4/32&#39;</span>
</span></span><span style=display:flex><span>set interfaces wireguard wg1 peer mobile_client public-key <span style=color:#e6db74>&#39;clientpubkey&#39;</span>
</span></span><span style=display:flex><span>set interfaces wireguard wg1 port <span style=color:#e6db74>&#39;132456&#39;</span>
</span></span><span style=display:flex><span>set interfaces wireguard wg1 private-key <span style=color:#e6db74>&#39;myprivkey&#39;</span>
</span></span></code></pre></div><h4 id=nat class=headerLink><a href=#nat class=header-mark></a>NAT</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>21940</span> description <span style=color:#e6db74>&#39;WireGuard VPN&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>21940</span> destination port <span style=color:#e6db74>&#39;132456&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>21940</span> inbound-interface name <span style=color:#e6db74>&#39;eth2&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>21940</span> protocol <span style=color:#e6db74>&#39;udp&#39;</span>
</span></span><span style=display:flex><span>set nat destination rule <span style=color:#ae81ff>21940</span> translation address <span style=color:#e6db74>&#39;10.25.30.1&#39;</span>
</span></span></code></pre></div><h4 id=firewall class=headerLink><a href=#firewall class=header-mark></a>Firewall</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 description <span style=color:#e6db74>&#39;LAN to WG IPv4&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 default-action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 default-log
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 rule <span style=color:#ae81ff>1</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 rule <span style=color:#ae81ff>1</span> state <span style=color:#e6db74>&#39;established&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 rule <span style=color:#ae81ff>1</span> state <span style=color:#e6db74>&#39;related&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 rule <span style=color:#ae81ff>2</span> action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name lan-wg-v4 rule <span style=color:#ae81ff>2</span> state <span style=color:#e6db74>&#39;invalid&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set firewall ipv4 name local-wg-v4 description <span style=color:#e6db74>&#39;This Router to wg IPv4&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name local-wg-v4 default-action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name local-wg-v4 default-log
</span></span><span style=display:flex><span>set firewall ipv4 name local-wg-v4 rule <span style=color:#ae81ff>1</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 description <span style=color:#e6db74>&#39;WAN to WG IPv4&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 default-action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 default-log
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 rule <span style=color:#ae81ff>1</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 rule <span style=color:#ae81ff>1</span> state <span style=color:#e6db74>&#39;related&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 rule <span style=color:#ae81ff>1</span> state <span style=color:#e6db74>&#39;established&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 rule <span style=color:#ae81ff>2</span> action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wan-wg-v4 rule <span style=color:#ae81ff>2</span> state <span style=color:#e6db74>&#39;invalid&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-lan-v4 rule <span style=color:#ae81ff>10</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-lan-v4 rule <span style=color:#ae81ff>10</span> description <span style=color:#e6db74>&#39;wg to server in LAN&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-lan-v4 rule <span style=color:#ae81ff>10</span> destination group address-group <span style=color:#e6db74>&#39;SERVER_IN_LAN&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-lan-v4 rule <span style=color:#ae81ff>10</span> protocol <span style=color:#e6db74>&#39;tcp_udp&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-lan-v4 rule <span style=color:#ae81ff>10</span> source group address-group <span style=color:#e6db74>&#39;WG_SERVER_ACCESS&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 description <span style=color:#e6db74>&#39;WG to This Router IPv4&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 default-action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 default-log
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>1</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>1</span> state <span style=color:#e6db74>&#39;established&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>1</span> state <span style=color:#e6db74>&#39;related&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>2</span> action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>2</span> state <span style=color:#e6db74>&#39;invalid&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>3</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>3</span> description <span style=color:#e6db74>&#39;explicit allow DNS&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>3</span> destination port <span style=color:#e6db74>&#39;53&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-local-v4 rule <span style=color:#ae81ff>3</span> protocol <span style=color:#e6db74>&#39;tcp_udp&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-wan-v4 description <span style=color:#e6db74>&#39;WG to WAN IPv4&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-wan-v4 default-action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall ipv4 name wg-wan-v4 default-log
</span></span><span style=display:flex><span>set firewall ipv4 name wg-wan-v4 rule <span style=color:#ae81ff>1</span> action <span style=color:#e6db74>&#39;accept&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set firewall zone lan from wg firewall name <span style=color:#e6db74>&#39;wg-lan-v4&#39;</span>
</span></span><span style=display:flex><span>set firewall zone local from wg firewall name <span style=color:#e6db74>&#39;wg-local-v4&#39;</span>
</span></span><span style=display:flex><span>set firewall zone wan from wg firewall name <span style=color:#e6db74>&#39;wg-wan-v4&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set firewall zone wg default-action <span style=color:#e6db74>&#39;drop&#39;</span>
</span></span><span style=display:flex><span>set firewall zone wg from lan firewall name <span style=color:#e6db74>&#39;lan-wg-v4&#39;</span>
</span></span><span style=display:flex><span>set firewall zone wg from local firewall name <span style=color:#e6db74>&#39;local-wg-v4&#39;</span>
</span></span><span style=display:flex><span>set firewall zone wg from wan firewall name <span style=color:#e6db74>&#39;wan-wg-v4&#39;</span>
</span></span><span style=display:flex><span>set firewall zone wg interface <span style=color:#e6db74>&#39;wg1&#39;</span>
</span></span></code></pre></div><h4 id=failover-rule-for-traffic-going-back-out class=headerLink><a href=#failover-rule-for-traffic-going-back-out class=header-mark></a>Failover rule for traffic going back out</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>40</span> failover
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>40</span> inbound-interface <span style=color:#e6db74>&#39;wg1&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>40</span> interface br150 weight <span style=color:#e6db74>&#39;100&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>40</span> interface eth2 weight <span style=color:#e6db74>&#39;150&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>40</span> interface eth5 weight <span style=color:#e6db74>&#39;50&#39;</span>
</span></span><span style=display:flex><span>set load-balancing wan rule <span style=color:#ae81ff>40</span> protocol <span style=color:#e6db74>&#39;all&#39;</span>
</span></span></code></pre></div><h3 id=todo class=headerLink><a href=#todo class=header-mark></a>TODO:</h3><h4 id=more-special-routing class=headerLink><a href=#more-special-routing class=header-mark></a>More special routing</h4><p>Like under opnsense I would like to be able to connect to my WAN2 and WAN3 routers even if the current WAN is Init7.</p><p>I set the following static routes but it doesn&rsquo;t work. I am still trying to figure out what I am missing as I see the traffic for 192.168.8.1 go out the Init7 Link when it should not.</p><p>Yallo Router</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set protocols static route 192.168.8.1/32 interface eth5
</span></span></code></pre></div><p>Swisscom Router</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set protocols static route 192.168.1.1/32 interface br150
</span></span></code></pre></div><h4 id=ipv6 class=headerLink><a href=#ipv6 class=header-mark></a>IPv6</h4><p>At some point&mldr;</p><h2 id=performance class=headerLink><a href=#performance class=header-mark></a>Performance</h2><p>The perfornamce is much better than with opnsense and also a reason why I switched over to VyOS.</p><p>This is from my proxy which is running under proxmox on my older server via trunk (SFP28) to the MS-01 routed through VyoS to the internet.</p><p><a href=https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566 target=_blank rel="noopener noreferrer"><figure><a class=lightgallery href=https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566.png title=Speedtest data-thumbnail=https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566.png><img loading=lazy src=https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566.png srcset="https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566.png, https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566.png 1.5x, https://www.speedtest.net/result/c/f11e8bde-e5a3-4fe7-9c-13-f0ef236d0566.png 2x" sizes=auto alt=Speedtest></a></figure></a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2025-05-23</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="Share on Twitter" data-sharer=twitter data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS" data-via=sschueller data-hashtags=VyOS,router,firewall,FTTH,Network><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Facebook" data-sharer=facebook data-url=https://sschueller.github.io/posts/vyos-router-update/ data-hashtag=VyOS><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Linkedin" data-sharer=linkedin data-url=https://sschueller.github.io/posts/vyos-router-update/><span class="fab fa-linkedin fa-fw"></span></button><button title="Share on WhatsApp" data-sharer=whatsapp data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS" data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="Share on Tumblr" data-sharer=tumblr data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS" data-tags=VyOS,router,firewall,FTTH,Network><span class="fab fa-tumblr fa-fw"></span></button><button title="Share on Hacker News" data-sharer=hackernews data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS"><span class="fab fa-hacker-news fa-fw"></span></button><button title="Share on Reddit" data-sharer=reddit data-url=https://sschueller.github.io/posts/vyos-router-update/><span class="fab fa-reddit fa-fw"></span></button><button title="Share on VK" data-sharer=vk data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS" data-image=ms-01><span class="fab fa-vk fa-fw"></span></button><button title="Share on Xing" data-sharer=xing data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS"><span class="fab fa-xing fa-fw"></span></button><button title="Share on Line" data-sharer=line data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS"><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="Share on 微博" data-sharer=weibo data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS" data-image=ms-01><span class="fab fa-weibo fa-fw"></span></button><button title="Share on 百度" data-sharer=baidu data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS"><span data-svg-src=/lib/simple-icons/icons/baidu.min.svg></span></button><button title="Share on Skype" data-sharer=skype data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS"><span class="fab fa-skype fa-fw"></span></button><button title="Share on Trello" data-sharer=trello data-url=https://sschueller.github.io/posts/vyos-router-update/ data-title="Upgrading my 25gbit internet router to VyOS" data-description><span class="fab fa-trello fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/vyos/>VyOS</a>,&nbsp;<a href=/tags/router/>Router</a>,&nbsp;<a href=/tags/firewall/>Firewall</a>,&nbsp;<a href=/tags/ftth/>FTTH</a>,&nbsp;<a href=/tags/network/>Network</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/turning-a-project-into-a-product/ class=prev rel=prev title="Turning a project into a product"><i class="fas fa-angle-left fa-fw"></i>Turning a project into a product</a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.147.5">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"sschueller/sschueller.github.io"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},sharerjs:!0}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script></div></body></html>